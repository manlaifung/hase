<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>香港餐廳隨機抽選器</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
@keyframes slot-scroll {
0% { transform: translateY(0); opacity: 0.5; }
100% { transform: translateY(-10px); opacity: 0.5; }
}
.animate-slot { animation: slot-scroll 0.1s infinite linear; }
</style>
</head>
<body>
<div id="root"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const appId = typeof __app_id !== 'undefined' ? __app_id : 'hk-food-picker-v1';
const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

window.FirebaseLib = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, addDoc, onSnapshot, collection };
window.EnvConfig = { firebaseConfig, appId, initialToken };
window.SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTk7oD5cjva7T40u7aqH0dCatgqsgcqmfYDgKOtKMLUtY4h2ttKv2Nr7B1306XiDDpBfV4-mr5lGC3D/pub?gid=0&single=true&output=csv";

const AppCode = `
const { useState, useEffect, useMemo, useCallback } = React;

// 直接定義圖示組件以避免外部 DOM 操作衝突
const Icon = ({ name, className = "w-4 h-4" }) => {
const icons = {
compass: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></svg>,
refresh: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>,
sparkles: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>,
navigation: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
quote: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.757-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2h.75c1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/></svg>
};
return icons[name] || null;
};

const DISTRICTS = [
{ value: "all", label: "全港地區" },
{ value: "Mong Kok", label: "旺角" },
{ value: "Tsim Sha Tsui", label: "尖沙咀" },
{ value: "Causeway Bay", label: "銅鑼灣" },
{ value: "Central", label: "中環" },
{ value: "Wan Chai", label: "灣仔" }
];

const WALK_TIMES = [
{ value: "all", label: "任何距離" },
{ value: "5", label: "少於 5 分鐘" },
{ value: "10", label: "少於 10 分鐘" },
{ value: "20", label: "少於 20 分鐘" },
{ value: "above20", label: "大於 20 分鐘" }
];

const SIZES = [
{ value: "", label: "未設定" },
{ value: "small", label: "細舖 (4人以下)" },
{ value: "medium", label: "中型 (4-8人)" },
{ value: "large", label: "大場 (8人以上)" }
];

function calculateDistance(lat1, lon1, lat2, lon2) {
const R = 6371;
const dLat = (lat2 - lat1) * Math.PI / 180;
const dLon = (lon2 - lon1) * Math.PI / 180;
const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
Math.sin(dLon / 2) * Math.sin(dLon / 2);
const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
return R * c;
}

window.App = function App() {
const [db, setDb] = useState(null);
const [user, setUser] = useState(null);
const [userLocation, setUserLocation] = useState(null);
const [locStatus, setLocStatus] = useState("pending");
const [sheetData, setSheetData] = useState([]);
const [cloudData, setCloudData] = useState([]);
const [loading, setLoading] = useState(true);
const [spinning, setSpinning] = useState(false);
const [spinName, setSpinName] = useState("");
const [result, setResult] = useState(null);
const [statusMsg, setStatusMsg] = useState(null);
const [isUpdating, setIsUpdating] = useState(false);

const [aiReview, setAiReview] = useState(null);
const [isGeneratingAi, setIsGeneratingAi] = useState(false);

const [filterDist, setFilterDist] = useState("all");
const [filterCuisine, setFilterCuisine] = useState("all");
const [filterWalk, setFilterWalk] = useState("all");

const requestLocation = useCallback(() => {
setLocStatus("pending");
if (!navigator.geolocation) {
setLocStatus("error");
return;
}

const options = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };
navigator.geolocation.getCurrentPosition(
(pos) => {
setUserLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude });
setLocStatus("success");
},
(err) => {
navigator.geolocation.getCurrentPosition(
(pos) => {
setUserLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude });
setLocStatus("success");
},
(err2) => {
setLocStatus(err2.code === 1 ? "denied" : "error");
},
{ enableHighAccuracy: false, timeout: 10000 }
);
},
options
);
}, []);

useEffect(() => {
const initAuth = async () => {
const fb = window.FirebaseLib;
const { firebaseConfig, initialToken } = window.EnvConfig;
try {
const app = fb.initializeApp(firebaseConfig);
const auth = fb.getAuth(app);
const firestore = fb.getFirestore(app);
setDb(firestore);
if (initialToken) await fb.signInWithCustomToken(auth, initialToken);
else await fb.signInAnonymously(auth);
fb.onAuthStateChanged(auth, setUser);
} catch (e) { setStatusMsg({ type: 'error', message: '數據庫連線失敗' }); }
};
initAuth();
requestLocation();
}, [requestLocation]);

useEffect(() => {
fetch(window.SHEET_URL)
.then(res => res.text())
.then(csv => {
const lines = csv.trim().split('\\n');
const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
const parsed = lines.slice(1).map(line => {
const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
const obj = {};
headers.forEach((h, i) => obj[h] = values[i]);
return { ...obj, source: 'Sheet' };
});
setSheetData(parsed);
setLoading(false);
})
.catch(err => setStatusMsg({ type: 'error', message: '無法載入表格數據' }));
}, []);

useEffect(() => {
if (!db || !user) return;
const fb = window.FirebaseLib;
const { appId } = window.EnvConfig;
const coll = fb.collection(db, 'artifacts', appId, 'public', 'data', 'restaurants');
return fb.onSnapshot(coll, (snap) => {
setCloudData(snap.docs.map(d => ({ id: d.id, ...d.data(), source: 'Cloud' })));
});
}, [db, user]);

const restaurants = useMemo(() => {
const cloudMap = new Map();
cloudData.forEach(r => cloudMap.set(r.name + r.address, r));
return sheetData.map(s => {
const key = s.name + s.address;
return cloudMap.has(key) ? cloudMap.get(key) : s;
});
}, [sheetData, cloudData]);

const dynamicCuisines = useMemo(() => {
const cuisines = new Set(restaurants.map(r => r.cuisine).filter(Boolean));
const list = Array.from(cuisines).sort().map(c => ({ value: c, label: c }));
return [{ value: "all", label: "所有菜式" }, ...list];
}, [restaurants]);

const generateAiReview = async () => {
if (!result || isGeneratingAi) return;
setIsGeneratingAi(true);
setAiReview(null);

const apiKey = "";
const prompt = \`你是一位著名的香港美食評論家。針對以下餐廳提供一段大約150字的繁體中文點評：名稱 \${result.name}，菜式 \${result.cuisine}，地區 \${result.district}。包含值得去的原因、2-3個建議單品和一句幽默結語。\`;

const callGemini = async (retryCount = 0) => {
try {
const response = await fetch(\`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=\${apiKey}\`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
});
const data = await response.json();
return data.candidates?.[0]?.content?.parts?.[0]?.text;
} catch (error) {
if (retryCount < 5) {
await new Promise(r => setTimeout(r, Math.pow(2, retryCount) * 1000));
return callGemini(retryCount + 1);
}
throw error;
}
};

try {
const review = await callGemini();
setAiReview(review);
} catch (error) {
setStatusMsg({ type: 'error', message: 'AI 點評生成失敗' });
} finally {
setIsGeneratingAi(false);
}
};

const handleRandom = () => {
const pool = restaurants.filter(r => {
const dMatch = filterDist === "all" || r.district === filterDist;
const cMatch = filterCuisine === "all" || r.cuisine === filterCuisine;
let wMatch = true;
if (filterWalk !== "all" && userLocation && r.lat && r.lng) {
const dist = calculateDistance(userLocation.lat, userLocation.lng, parseFloat(r.lat), parseFloat(r.lng));
const time = Math.round(dist * 16.5);
if (filterWalk === "5") wMatch = time < 5;
else if (filterWalk === "10") wMatch = time < 10;
else if (filterWalk === "20") wMatch = time < 20;
else if (filterWalk === "above20") wMatch = time >= 20;
}
return dMatch && cMatch && wMatch;
});

if (pool.length === 0) {
setStatusMsg({ type: 'error', message: '找不到符合條件的餐廳' });
return;
}

setSpinning(true);
setResult(null);
setAiReview(null);
let count = 0;
const interval = setInterval(() => {
setSpinName(pool[Math.floor(Math.random() * pool.length)].name);
if (++count > 20) {
clearInterval(interval);
setResult(pool[Math.floor(Math.random() * pool.length)]);
setSpinning(false);
}
}, 70);
};

const updateField = async (field, value) => {
if (!db || !user || !result || isUpdating) return;
const fb = window.FirebaseLib;
const { appId } = window.EnvConfig;
setIsUpdating(true);
try {
const updatedResult = { ...result, [field]: value, source: 'Cloud' };
if (result.source === 'Cloud' && result.id) {
await fb.setDoc(fb.doc(db, 'artifacts', appId, 'public', 'data', 'restaurants', result.id), updatedResult, { merge: true });
setResult(updatedResult);
} else {
const { id, ...cleanData } = updatedResult;
const docRef = await fb.addDoc(fb.collection(db, 'artifacts', appId, 'public', 'data', 'restaurants'), cleanData);
setResult({ ...updatedResult, id: docRef.id });
}
setStatusMsg({ type: 'success', message: '已保存到雲端' });
setTimeout(() => setStatusMsg(null), 1500);
} catch (e) { setStatusMsg({ type: 'error', message: '更新失敗' }); }
setIsUpdating(false);
};

if (loading) return (
<div className="flex flex-col h-screen items-center justify-center space-y-4">
<div className="w-10 h-10 border-4 border-green-500 border-t-transparent rounded-full animate-spin"></div>
<p className="font-bold text-slate-400">載入餐廳中...</p>
</div>
);

return (
<div className="max-w-md mx-auto min-h-screen bg-slate-50 flex flex-col shadow-2xl relative overflow-hidden">
<header className="bg-gradient-to-br from-green-600 to-green-700 p-8 text-white rounded-b-[40px] shadow-lg relative z-10">
<div className="flex justify-between items-center">
<div className="flex items-center gap-3">
<div className="bg-white/20 p-2.5 rounded-xl">
<Icon name="compass" className="w-6 h-6" />
</div>
<div>
<h1 className="text-xl font-black">搵食抽選器</h1>
<div className="flex items-center gap-1.5">
<div className={"w-2 h-2 rounded-full " + (locStatus === 'success' ? 'bg-green-400' : locStatus === 'pending' ? 'bg-yellow-400 animate-pulse' : 'bg-red-400')}></div>
<p className="text-[10px] font-bold opacity-80 uppercase tracking-tighter">
{locStatus === 'success' ? 'GPS 已連線' : locStatus === 'pending' ? '定位搜尋中...' : '定位失敗'}
</p>
</div>
</div>
</div>
<button onClick={requestLocation} className="bg-white/20 hover:bg-white/30 p-2 rounded-lg transition-colors active:scale-90">
<Icon name="refresh" className="w-4 h-4" />
</button>
</div>
</header>

<main className="flex-1 p-6 -mt-6 relative z-20 space-y-6">
{statusMsg && (
<div className={"p-3 rounded-2xl text-center text-[11px] font-black shadow-sm border " +
(statusMsg.type === 'success' ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700')}>
{statusMsg.message}
</div>
)}

<div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 space-y-4">
<div className="grid grid-cols-3 gap-2">
<div className="space-y-1">
<label className="text-[9px] font-black text-slate-400 uppercase ml-1">地區</label>
<select value={filterDist} onChange={e => setFilterDist(e.target.value)}
className="w-full bg-slate-50 p-2.5 rounded-xl text-[11px] font-bold text-slate-700 outline-none appearance-none border border-transparent focus:border-green-500">
{DISTRICTS.map(d => <option key={d.value} value={d.value}>{d.label}</option>)}
</select>
</div>
<div className="space-y-1">
<label className="text-[9px] font-black text-slate-400 uppercase ml-1">菜式</label>
<select value={filterCuisine} onChange={e => setFilterCuisine(e.target.value)}
className="w-full bg-slate-50 p-2.5 rounded-xl text-[11px] font-bold text-slate-700 outline-none appearance-none border border-transparent focus:border-green-500">
{dynamicCuisines.map(c => <option key={c.value} value={c.value}>{c.label}</option>)}
</select>
</div>
<div className="space-y-1">
<label className="text-[9px] font-black text-slate-400 uppercase ml-1">步行</label>
<select value={filterWalk} onChange={e => setFilterWalk(e.target.value)}
className="w-full bg-slate-50 p-2.5 rounded-xl text-[11px] font-bold text-slate-700 outline-none appearance-none border border-transparent focus:border-green-500">
{WALK_TIMES.map(w => <option key={w.value} value={w.value}>{w.label}</option>)}
</select>
</div>
</div>
<button onClick={handleRandom} disabled={spinning}
className="w-full bg-slate-900 hover:bg-black text-white py-4 rounded-2xl font-black text-base shadow-xl active:scale-95 transition-all disabled:opacity-50">
{spinning ? '搜尋中...' : '即刻抽選'}
</button>
</div>

{spinning && (
<div className="py-8 text-center overflow-hidden">
<div className="text-2xl font-black text-green-600 animate-slot">{spinName}</div>
</div>
)}

{result && !spinning && (
<div className="space-y-4 animate-in fade-in slide-in-from-bottom-8">
<div className="bg-white border-2 border-green-500 rounded-[40px] overflow-hidden shadow-2xl">
<div className="p-7 space-y-4">
<div className="flex justify-between items-start">
<div>
<h2 className="text-xl font-black text-slate-900 leading-tight">{result.name}</h2>
<div className="flex gap-2 mt-1">
<span className="bg-slate-100 text-slate-500 text-[9px] font-black px-2 py-0.5 rounded-full">{result.cuisine}</span>
<span className="bg-slate-100 text-slate-500 text-[9px] font-black px-2 py-0.5 rounded-full">{result.district}</span>
</div>
</div>
<button
onClick={generateAiReview}
disabled={isGeneratingAi}
className="bg-green-100 text-green-700 p-2 rounded-xl hover:bg-green-200 transition-colors active:scale-90"
>
{isGeneratingAi ? (
<div className="w-5 h-5 border-2 border-green-600 border-t-transparent rounded-full animate-spin"></div>
) : (
<Icon name="sparkles" className="w-5 h-5" />
)}
</button>
</div>

{(userLocation && result.lat && result.lng) ? (
<div className="bg-blue-50 p-4 rounded-2xl flex items-center justify-around border border-blue-100">
<div className="text-center">
<p className="text-[9px] font-black text-blue-400 uppercase">直線距離</p>
<p className="text-base font-black text-blue-700">{calculateDistance(userLocation.lat, userLocation.lng, parseFloat(result.lat), parseFloat(result.lng)).toFixed(1)} km</p>
</div>
<div className="h-8 w-[1px] bg-blue-200 opacity-50"></div>
<div className="text-center">
<p className="text-[9px] font-black text-blue-400 uppercase">步行約</p>
<p className="text-base font-black text-blue-700">{Math.round(calculateDistance(userLocation.lat, userLocation.lng, parseFloat(result.lat), parseFloat(result.lng)) * 16.5)} 分鐘</p>
</div>
</div>
) : (
<div className="bg-slate-100 p-3 rounded-2xl text-center">
<p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">缺少坐標或 GPS</p>
</div>
)}

{aiReview && (
<div className="bg-gradient-to-br from-green-50 to-white border border-green-100 p-5 rounded-3xl relative overflow-hidden group">
<h3 className="text-[10px] font-black text-green-600 uppercase tracking-[0.2em] mb-2 flex items-center gap-1.5">
<Icon name="quote" className="w-3 h-3" /> Gemini 智能點評
</h3>
<p className="text-[13px] text-slate-700 leading-relaxed font-medium italic">
「{aiReview}」
</p>
</div>
)}

<div className="grid grid-cols-2 gap-3">
<div className="space-y-1">
<span className="text-[9px] font-black text-slate-400 uppercase ml-1">上次到訪</span>
<input type="date" value={result.lastVisitedDate || ""}
onChange={e => updateField('lastVisitedDate', e.target.value)}
className="w-full text-[11px] font-bold text-slate-700 bg-slate-50 p-2.5 rounded-xl outline-none" />
</div>
<div className="space-y-1">
<span className="text-[9px] font-black text-slate-400 uppercase ml-1">大小</span>
<select value={result.size || ""}
onChange={e => updateField('size', e.target.value)}
className="w-full text-[11px] font-bold text-slate-700 bg-slate-50 p-2.5 rounded-xl outline-none appearance-none">
{SIZES.map(s => <option key={s.value} value={s.value}>{s.label}</option>)}
</select>
</div>
</div>

<a href={"https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(result.address)}
target="_blank" className="flex items-center justify-center gap-2 py-3.5 bg-slate-900 text-white rounded-2xl hover:bg-black transition-all">
<Icon name="navigation" className="w-4 h-4" />
<span className="text-[11px] font-bold uppercase tracking-widest">開啟 Google Maps</span>
</a>
</div>
</div>
<button onClick={generateAiReview} className="w-full py-4 border-2 border-dashed border-green-300 rounded-3xl text-green-600 text-[12px] font-black uppercase tracking-widest hover:bg-green-50 transition-colors flex items-center justify-center gap-2">
<Icon name="sparkles" className="w-4 h-4" />
{isGeneratingAi ? '正在調用 Gemini...' : (aiReview ? '重新生成點評' : '✨ 獲取美食點評')}
</button>
</div>
)}
</main>

<footer className="p-6 text-center">
<p className="text-[9px] text-slate-300 font-black tracking-widest uppercase">
Data: Google Sheets • AI: Gemini 2.5 Flash
</p>
</footer>
</div>
);
}
`;

const transformedCode = Babel.transform(AppCode, { presets: ['react'] }).code;
const script = document.createElement('script');
script.text = transformedCode;
document.head.appendChild(script);

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(window.App));
</script>
</body>
</html>
